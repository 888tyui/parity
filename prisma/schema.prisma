generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  wallet    String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects Project[]
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId    String
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  contracts Contract[]
}

model Contract {
  id        String   @id @default(cuid())
  filename  String
  source    String
  framework String   @default("anchor")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projectId String
  project   Project         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  analyses  AgentAnalysis[]
}

model AgentAnalysis {
  id         String   @id @default(cuid())
  score      Int
  status     String   @default("completed")
  findings   Json     // Native JSON for PostgreSQL
  agentLog   String?
  createdAt  DateTime @default(now())

  contractId String
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model Waitlist {
  id        Int      @id @default(autoincrement())
  wallet    String   @unique
  email     String
  path      String?
  createdAt DateTime @default(now())
}

// ── Verepo: Result Cache ──
model VerepoResult {
  id         String   @id @default(cuid())
  repoUrl    String              // Original URL
  repoOwner  String              // e.g. "solana-labs"
  repoName   String              // e.g. "example-helloworld"
  repoKey    String   @unique    // "owner/repo" normalized key
  commitSha  String?             // Latest HEAD SHA — used for cache invalidation
  status     String   @default("analyzing") // "analyzing" | "done" | "error"
  result     Json?               // VerepoResponse + meta (native JSON)
  error      String?
  filesCount Int      @default(0)
  totalLines Int      @default(0)
  tokenCount Int      @default(0)  // Estimated input tokens sent to LLM
  analyzedBy String?             // wallet pubkey or IP
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

// ── Verepo: Daily Usage Tracking ──
model VerepoUsage {
  id        String   @id @default(cuid())
  key       String              // wallet pubkey or "ip:xxx.xxx.xxx.xxx"
  type      String              // "wallet" | "ip"
  date      String              // "2026-02-19" (UTC date for daily bucket)
  count     Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([key, type, date])
}
